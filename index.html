<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Cuadrantes</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); padding: 15px; margin: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid var(--tg-theme-hint-color, #ccc); border-radius: 8px; background-color: var(--tg-theme-secondary-bg-color, #f4f4f5); color: var(--tg-theme-text-color, #000); font-size: 14px; }
        
        /* DISEÑO AISLADO */
        .row-horas { display: flex; gap: 15px; margin-bottom: 15px; }
        .row-horas .form-group { flex: 1; margin-bottom: 0; }

        .usuario-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .usuario-row select { width: 65%; }
        .usuario-row input { width: 35%; }
        
        button { width: 100%; padding: 12px; background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background-color: var(--tg-theme-hint-color, #999); margin-bottom: 15px; }
        #informe-container { display: none; margin-top: 20px; padding: 15px; background-color: var(--tg-theme-secondary-bg-color, #f4f4f5); border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 14px; }
        #loading-overlay { text-align: center; font-weight: bold; color: var(--tg-theme-hint-color, #999); margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2>Configurar Reparto</h2>
    
    <div class="form-group">
        <label>Fecha de la Jornada</label>
        <input type="date" id="fecha" required>
    </div>

    <div class="row-horas">
        <div class="form-group">
            <label>Hora Inicio</label>
            <input type="time" id="hora_inicio" required>
        </div>
        <div class="form-group">
            <label>Hora Fin</label>
            <input type="time" id="hora_fin" required>
        </div>
    </div>

    <div class="form-group">
        <label>Número de Tandas</label>
        <input type="number" id="num_tandas" value="1" min="1">
    </div>

    <h3>Personal Activo</h3>
    <div id="loading-overlay">⏳ Cargando base de datos del personal...</div>
    <div id="usuarios-container"></div>
    
    <button class="btn-secondary" id="btn-add-user" onclick="agregarFilaUsuario()" style="display:none;">+ Añadir otro componente</button>

    <button onclick="procesarDatos()" id="btn-submit" style="display:none;">Generar Cuadrante</button>
    
    <div id="mensaje-estado" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
    
    <div id="informe-container"></div>
    <button id="btn-copiar" style="display:none;" onclick="copiarInforme()">Copiar Informe al Portapapeles</button>

    <script>
        const webapp = window.Telegram.WebApp;
        webapp.ready();
        webapp.expand();

        const API_URL = "https://script.google.com/macros/s/AKfycbykEL_-xeD3I78sA6H22mZy50w6ECAbye9LVBZ2iLZ7w123Pt6FJ8f4kG48W0DmQTU0/exec";

        let listaPersonal = [];

        document.getElementById('fecha').valueAsDate = new Date();

        window.onload = function() {
            fetch(API_URL)
            .then(res => res.json())
            .then(datos => {
                if (datos.estado === "exito") {
                    listaPersonal = datos.personal;
                    document.getElementById('loading-overlay').style.display = "none";
                    document.getElementById('btn-add-user').style.display = "block";
                    document.getElementById('btn-submit').style.display = "block";
                    agregarFilaUsuario();
                } else {
                    document.getElementById('loading-overlay').innerText = "❌ Error al cargar personal.";
                    document.getElementById('loading-overlay').style.color = "red";
                }
            })
            .catch(err => {
                document.getElementById('loading-overlay').innerText = "❌ Error de red.";
                document.getElementById('loading-overlay').style.color = "red";
            });
        };

        function agregarFilaUsuario() {
            const container = document.getElementById('usuarios-container');
            const row = document.createElement('div');
            row.className = 'usuario-row'; 
            
            let opcionesHTML = `<option value="">Seleccionar...</option>`;
            listaPersonal.forEach(persona => {
                opcionesHTML += `<option value="${persona.id}">${persona.nombre}</option>`;
            });

            row.innerHTML = `
                <select class="user-id">
                    ${opcionesHTML}
                </select>
                <input type="number" class="user-sorteo" placeholder="Nº Sorteo">
            `;
            container.appendChild(row);
        }

        function calcularMinutos(inicio, fin) {
            let [h1, m1] = inicio.split(':').map(Number);
            let [h2, m2] = fin.split(':').map(Number);
            let min1 = h1 * 60 + m1;
            let min2 = h2 * 60 + m2;
            if (min2 < min1) min2 += 24 * 60;
            return min2 - min1;
        }

        // LÍNEA RESTAURADA: Declaración de la función procesarDatos
        function procesarDatos() {
            const estadoDiv = document.getElementById("mensaje-estado");
            const informeDiv = document.getElementById("informe-container");
            const btnCopiar = document.getElementById("btn-copiar");
            
            estadoDiv.innerText = "Calculando...";
            estadoDiv.style.color = "orange";
            informeDiv.style.display = "none";
            btnCopiar.style.display = "none";

            const fecha = document.getElementById("fecha").value;
            const horaInicio = document.getElementById("hora_inicio").value;
            const horaFin = document.getElementById("hora_fin").value;
            
            if (!fecha || !horaInicio || !horaFin) {
                estadoDiv.innerText = "Faltan datos de tiempo.";
                estadoDiv.style.color = "red";
                return;
            }

            const idJornada = "J-" + fecha.replace(/-/g, "");
            
            const dateObj = new Date(fecha);
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yy = String(dateObj.getFullYear()).slice(-2);
            
            const hIniLimpia = horaInicio.replace(":", "");
            const hFinLimpia = horaFin.replace(":", "");
            const idTramo = `T-${hIniLimpia}${hFinLimpia}${dd}${mm}${yy}`;

            const minutosRestantes = calcularMinutos(horaInicio, horaFin);

            const filasUsuarios = document.querySelectorAll('.usuario-row');
            let personalActivo = [];
            filasUsuarios.forEach(fila => {
                let id = fila.querySelector('.user-id').value;
                let sorteo = parseInt(fila.querySelector('.user-sorteo').value);
                if (id && !isNaN(sorteo)) {
                    personalActivo.push({ id_usuario: id, sorteo: sorteo });
                }
            });

            if (personalActivo.length === 0) {
                estadoDiv.innerText = "Añade al menos un usuario válido con su sorteo.";
                estadoDiv.style.color = "red";
                return;
            }

            const payload = {
                id_jornada: idJornada,
                id_tramo: idTramo,
                fecha: fecha,
                hora_inicio_tramo: horaInicio,
                minutos_restantes: minutosRestantes,
                num_tandas: document.getElementById("num_tandas").value,
                personal_activo: personalActivo
            };

            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(datos => {
                if (datos.estado === "exito") {
                    estadoDiv.innerText = "Guardado con éxito.";
                    estadoDiv.style.color = "green";
                    informeDiv.innerText = datos.informe;
                    informeDiv.style.display = "block";
                    btnCopiar.style.display = "block";
                    webapp.HapticFeedback.notificationOccurred("success");
                } else {
                    estadoDiv.innerText = "Error: " + datos.mensaje;
                    estadoDiv.style.color = "red";
                }
            })
            .catch(err => {
                estadoDiv.innerText = "Error de conexión.";
                estadoDiv.style.color = "red";
            });
        }

        function copiarInforme() {
            const texto = document.getElementById("informe-container").innerText;
            navigator.clipboard.writeText(texto).then(() => {
                webapp.showAlert("Informe copiado. Ya puedes pegarlo en el chat.");
            });
        }
    </script>
</body>
</html>

